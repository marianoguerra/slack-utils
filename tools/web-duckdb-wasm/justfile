# web-duckdb-wasm justfile

# Default recipe to list available targets
default:
    @just --list

# Install dependencies
install:
    bun install

# Build the app bundle (minified)
build:
    bun run build

# Clean dist folder
clean:
    rm -rf dist

# Full rebuild
rebuild: clean install build

# ─────────────────────────────────────────────────────────────────────────────
# Development Servers
# ─────────────────────────────────────────────────────────────────────────────

# Start the dev server with API endpoints (compatible with slack-archive-server)
# Requires parquet files at the specified path
serve path="." port="3000":
    bun serve.js --path {{path}} --port {{port}}

# Start with hot reload
dev path="." port="3000":
    bun --hot serve.js --path {{path}} --port {{port}}

# Start static file server (for pre-built deployments)
serve-static path="." port="3000":
    bun static-file-server.js --path {{path}} --port {{port}}

# ─────────────────────────────────────────────────────────────────────────────
# Testing with slack-archive-server
# ─────────────────────────────────────────────────────────────────────────────

# Serve this app via slack-archive-server (tests full API compatibility)
serve-with-server base_path="." port="8080":
    #!/usr/bin/env bash
    set -e
    bun install && bun run build
    CONFIG=$(mktemp --suffix=.toml)
    cat > "$CONFIG" <<EOF
    [server]
    host = "127.0.0.1"
    port = {{port}}
    static_assets = "$(pwd)"

    [slack-archive]
    base_path = "{{base_path}}"
    EOF
    echo "Starting slack-archive-server on http://127.0.0.1:{{port}}"
    echo "Archive base path: {{base_path}}"
    echo "Web UI: http://127.0.0.1:{{port}}/index.html"
    echo ""
    trap "rm -f $CONFIG" EXIT
    cd ../.. && cargo run --features server --bin slack-archive-server -- serve "$CONFIG"
