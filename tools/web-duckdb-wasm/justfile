# web-duckdb-wasm justfile

# Default recipe to list available targets
default:
    @just --list

# Install dependencies
install:
    bun install

# Build the app bundle (minified)
build:
    bun run build

# Clean dist folder
clean:
    rm -rf dist

# Full rebuild
rebuild: clean install build

# ─────────────────────────────────────────────────────────────────────────────
# Development Servers
# ─────────────────────────────────────────────────────────────────────────────

# Start the dev server with API endpoints (compatible with slack-archive-server)
# Requires parquet files at the specified path
serve path="." port="3000":
    bun serve.js --path {{path}} --port {{port}}

# Start with hot reload
dev path="." port="3000":
    bun --hot serve.js --path {{path}} --port {{port}}

# Start static file server (for pre-built deployments)
serve-static path="." port="3000":
    bun static-file-server.js --path {{path}} --port {{port}}

# ─────────────────────────────────────────────────────────────────────────────
# Static Export
# ─────────────────────────────────────────────────────────────────────────────

# Export a self-contained static UI with parquet files for static hosting
# Creates dist/static-ui/ with everything needed for deployment
export-static-ui path:
    #!/usr/bin/env bash
    set -e

    # Validate source path
    if [ ! -d "{{path}}" ]; then
        echo "Error: Path '{{path}}' does not exist or is not a directory"
        exit 1
    fi

    PARQUET_PATH="$(cd "{{path}}" && pwd)"

    # Check required files exist
    if [ ! -f "$PARQUET_PATH/users.parquet" ]; then
        echo "Error: users.parquet not found in {{path}}"
        exit 1
    fi
    if [ ! -f "$PARQUET_PATH/channels.parquet" ]; then
        echo "Error: channels.parquet not found in {{path}}"
        exit 1
    fi
    if [ ! -d "$PARQUET_PATH/conversations" ]; then
        echo "Error: conversations/ directory not found in {{path}}"
        exit 1
    fi

    echo "Building app..."
    bun install
    bun run build

    echo "Creating dist/static-ui/..."
    rm -rf dist/static-ui
    mkdir -p dist/static-ui

    # Copy web assets
    cp static-files.html dist/static-ui/index.html
    cp dist/app.js dist/static-ui/app.js
    cp style.css dist/static-ui/style.css

    # Copy parquet files
    echo "Copying parquet files from $PARQUET_PATH..."
    cp "$PARQUET_PATH/users.parquet" dist/static-ui/
    cp "$PARQUET_PATH/channels.parquet" dist/static-ui/
    cp -r "$PARQUET_PATH/conversations" dist/static-ui/

    # Count files for summary
    THREAD_FILES=$(find dist/static-ui/conversations -name "*.parquet" 2>/dev/null | wc -l)
    TOTAL_SIZE=$(du -sh dist/static-ui | cut -f1)

    echo ""
    echo "Static UI exported to dist/static-ui/"
    echo "  - index.html"
    echo "  - app.js"
    echo "  - style.css"
    echo "  - users.parquet"
    echo "  - channels.parquet"
    echo "  - conversations/ ($THREAD_FILES thread files)"
    echo ""
    echo "Total size: $TOTAL_SIZE"
    echo ""
    echo "To serve locally: cd dist/static-ui && python3 -m http.server 8000"
    echo "Or deploy to any static hosting (GitHub Pages, S3, Netlify, etc.)"

# ─────────────────────────────────────────────────────────────────────────────
# Testing with slack-archive-server
# ─────────────────────────────────────────────────────────────────────────────

# Serve this app via slack-archive-server (tests full API compatibility)
serve-with-server base_path="." port="8080":
    #!/usr/bin/env bash
    set -e
    bun install && bun run build
    CONFIG=$(mktemp --suffix=.toml)
    cat > "$CONFIG" <<EOF
    [server]
    host = "127.0.0.1"
    port = {{port}}
    static_assets = "$(pwd)"

    [slack-archive]
    base_path = "{{base_path}}"
    EOF
    echo "Starting slack-archive-server on http://127.0.0.1:{{port}}"
    echo "Archive base path: {{base_path}}"
    echo "Web UI: http://127.0.0.1:{{port}}/index.html"
    echo ""
    trap "rm -f $CONFIG" EXIT
    cd ../.. && cargo run --features server --bin slack-archive-server -- serve "$CONFIG"
